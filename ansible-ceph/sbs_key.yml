  - name: Copy secret.xml
    copy: dest=/tmp/secret.xml src=files/sbs/secret.xml

  - name: Copy client.cinder.key
    copy: dest=/tmp/client.cinder.key src=files/sbs/client.cinder.key

  - name: Create virutal devices for librbd
    shell: virsh secret-define --file /tmp/secret.xml|awk '{print $2}'
    register: create_virt_devices

  - name: Set secret value
    shell: virsh secret-set-value --secret '{{ create_virt_devices.stdout }}' --base64 $(cat /tmp/client.cinder.key)

  - name: Delete secret.xml
    file: dest=/tmp/client.cinder.key state=absent

  - name: Delete client.cinder.key
    file: dest=/tmp/secret.xml state=absent

  - name: Setup directories
    file: dest="{{ item }}" recurse=yes state=directory 
    #owner=qemu group=libvirtd
    with_items:
      - /var/run/ceph/guests/
      - /var/log/qemu/

